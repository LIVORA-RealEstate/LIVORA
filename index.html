<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIVORA โ ููููุฑุง</title>

  <!-- ููุน ุงููุงุด ุฃุซูุงุก ุงูุชุทููุฑ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- SEO ุฃุณุงุณู -->
  <meta name="description" content="LIVORA โ ููููุฑุง: ููุตุฉ ูุณุงุทุฉ ุนูุงุฑูุฉ ููุซููุฉ ูุตููุงุช ุงูุฃุฑุงุถูุ ุงูุดููุ ุงููุฌูุนุงุช ูุงููุฏุงุฑุณ. ุชูุซูู ุฑุณููุ ุชุญูู ููููุฉุ ุดุจูุฉ ูุณุชุซูุฑูู ูุญููุฉ ูุฎููุฌูุฉุ ูุงุชุณุงุจ ูุจุฑูุฏ ูุจุงุดุฑ." />
  <meta property="og:title" content="LIVORA โ ููููุฑุง ุงูุนูุงุฑูุฉ" />
  <meta property="og:description" content="ูุณุงุทุฉ ููุซููุฉ + ุชูุซูู + ุชุญูู ููููุฉ + ุดุจูุฉ ูุณุชุซูุฑูู. ุชูุงุตู ูุจุงุดุฑ ุนุจุฑ ูุงุชุณุงุจ ุฃู ุงูุจุฑูุฏ." />

  <!-- Google Analytics GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2WXJ9SL5LP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2WXJ9SL5LP'); // LIVORA GA4
  </script>

  <!-- Tailwind + React UMD + Babel -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- (ุงุฎุชูุงุฑู ูุงุญููุง: ุฎุฑูุทุฉ Leaflet) -->
  <!--
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  -->

  <style>
    :root { --font-ar: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Sans"; }
    body { font-family: var(--font-ar); background:#fafafa; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // ================== ุฅุนุฏุงุฏุงุช ุงูุจุฑุงูุฏ ==================
    const BRAND = {
      nameEn: "LIVORA",
      nameAr: "ููููุฑุง",
      phoneIntl: "+962796353701",
      whatsappBase: "https://wa.me/962796353701",
      email: "livoraestate.global@gmail.com",
    };
    const whatsappLink = BRAND.whatsappBase + "?text=" + encodeURIComponent("ูุฑุญุจุงูุ ุฃุฑูุฏ ุชูุงุตูู ุนูุงุฑุงุช ููููุฑุง");
    // =====================================================

    // ====== ุฑูุงุจุท Google Sheet / Google Form ======
    const CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqmT5i7QVxFy-laVQN9K2R-Xgz-rNorv0CXS-a9dZd1DF8SMM3JF3ElzTNvV1oXoHKazCL0vRj5sVr/pub?gid=0&single=true&output=csv";
    const FORM_URL = ""; // โ ุถุน ููุง ูุงุญููุง ุฑุงุจุท Google Form (ุงุฎุชูุงุฑู)
    // ==============================================

    // ุชุชุจูุน ุฃุญุฏุงุซ ูุฎุตูุตุฉ ุฅูู GA4
    function track(eventName, params = {}) {
      if (window.gtag) { window.gtag('event', eventName, params); }
    }

    // ============= ุงูุนููุงุช + ุฃุณุนุงุฑ ุงูุตุฑู =============
    const CURRENCIES = [
      { code:"JOD", label:"ุฏููุงุฑ ุฃุฑุฏูู" },
      { code:"USD", label:"ุฏููุงุฑ ุฃูุฑููู" },
      { code:"AED", label:"ุฏุฑูู ุฅูุงุฑุงุชู" },
      { code:"SAR", label:"ุฑูุงู ุณุนูุฏู" },
      { code:"EUR", label:"ููุฑู" },
      { code:"KWD", label:"ุฏููุงุฑ ูููุชู" },
      { code:"QAR", label:"ุฑูุงู ูุทุฑู" },
      { code:"OMR", label:"ุฑูุงู ุนููุงูู" },
      { code:"BHD", label:"ุฏููุงุฑ ุจุญุฑููู" },
    ];
    const FALLBACK_RATES = {
      base: "JOD",
      rates: { JOD:1, USD:1.41, AED:5.18, SAR:5.29, EUR:1.30, KWD:0.43, QAR:5.14, OMR:0.54, BHD:0.53 }
    };
    async function getRates(){
      try {
        const r = await fetch("https://api.exchangerate.host/latest?base=JOD&symbols=JOD,USD,AED,SAR,EUR,KWD,QAR,OMR,BHD");
        const j = await r.json();
        if(j && j.rates) return { base:"JOD", rates: j.rates };
        return FALLBACK_RATES;
      } catch { return FALLBACK_RATES; }
    }
    function useRates(){
      const [data,setData]=useState(FALLBACK_RATES);
      useEffect(()=>{ getRates().then(setData); },[]);
      return data;
    }
    function sym(code){ return ({JOD:"ุฏููุงุฑ",USD:"$",AED:"ุฏ.ุฅ",SAR:"ุฑ.ุณ",EUR:"โฌ",KWD:"ุฏ.ู",QAR:"ุฑ.ู",OMR:"ุฑ.ุน",BHD:"ุฏ.ุจ"}[code]||code); }
    function moneyByCode(v, code){ return `${Number(v||0).toLocaleString()} ${sym(code)}`; }

    // ุฃุฏูุงุช
    function getUTM(){
      const p = new URLSearchParams(window.location.search);
      const keys = ["utm_source","utm_medium","utm_campaign","utm_content"]; const parts=[];
      keys.forEach(k=>{ const v=p.get(k); if(v) parts.push(k+":"+v); });
      return parts.join("|");
    }
    function buildWhatsAppMessage(base){
      const utm = getUTM();
      const suffix = utm ? "\n\nRef:"+utm : "";
      return encodeURIComponent(base+suffix);
    }

    // ุญุงุณุจุฉ ุงูุนูููุฉ
    function CommissionCalculator({currency, rates}){
      const [priceJOD,setPriceJOD]=useState(1000000);
      const [rate,setRate]=useState(1.5);
      const r = rates?.rates?.[currency] || 1;
      const priceSel = (Number(priceJOD)||0) * r;
      const commissionSel = (priceSel * (Number(rate)||0))/100;
      return (
        <div className="rounded-3xl border bg-white p-5 shadow-sm">
          <div className="font-bold mb-2">ุญุงุณุจุฉ ุงูุนูููุฉ</div>
          <div className="grid grid-cols-2 gap-2 text-sm">
            <input className="px-3 py-2 rounded-xl border" type="number" value={priceJOD} onChange={e=>setPriceJOD(e.target.value)} placeholder="ูููุฉ ุงูุตููุฉ (JOD)"/>
            <input className="px-3 py-2 rounded-xl border" type="number" step="0.25" value={rate} onChange={e=>setRate(e.target.value)} placeholder="% ุงูุนูููุฉ"/>
          </div>
          <div className="mt-3 text-sm">
            ูููุฉ ุงูุตููุฉ ุจุนููุชู: <b>{moneyByCode(priceSel, currency)}</b><br/>
            ุงูุนูููุฉ: <b>{moneyByCode(commissionSel, currency)}</b>
          </div>
        </div>
      );
    }

    // ุญุงุณุจุฉ ุงูุนุงุฆุฏ ุงูุชุฃุฌูุฑู
    function RoiCalculator({currency, rates}){
      const [priceJOD,setPriceJOD]=useState(150000);
      const [monthlyJOD,setMonthlyJOD]=useState(700);
      const [occ,setOcc]=useState(95);
      const r = rates?.rates?.[currency] || 1;
      const annualNetSel = (Number(monthlyJOD)||0)*12*((Number(occ)||0)/100)*r;
      const priceSel = (Number(priceJOD)||0)*r;
      const roi = priceSel ? (annualNetSel/priceSel)*100 : 0;
      return (
        <div className="rounded-3xl border bg-white p-5 shadow-sm">
          <div className="font-bold mb-2">ุญุงุณุจุฉ ุงูุนุงุฆุฏ ุงูุชุฃุฌูุฑู</div>
          <div className="grid grid-cols-3 gap-2 text-sm">
            <input className="px-3 py-2 rounded-xl border" type="number" value={priceJOD} onChange={e=>setPriceJOD(e.target.value)} placeholder="ุณุนุฑ ุงูุนูุงุฑ (JOD)"/>
            <input className="px-3 py-2 rounded-xl border" type="number" value={monthlyJOD} onChange={e=>setMonthlyJOD(e.target.value)} placeholder="ุงูุฅูุฌุงุฑ ุงูุดูุฑู (JOD)"/>
            <input className="px-3 py-2 rounded-xl border" type="number" value={occ} onChange={e=>setOcc(e.target.value)} placeholder="% ุงูุฅุดุบุงู"/>
          </div>
          <div className="mt-3 text-sm">ุตุงูู ุงูุฏุฎู ุงูุณููู: <b>{moneyByCode(annualNetSel, currency)}</b></div>
          <div className="text-sm">ุงูุนุงุฆุฏ ุงูุชูุฑูุจู: <b>{Number(roi).toFixed(2)}%</b></div>
        </div>
      );
    }

    // Valuator Pro โ (ุจุฏูู ุฑุจุง) ุชุณุนูุฑ + ุนุงุฆุฏ ููุท
    function ValuatorPro({ currency, rates }) {
      const r = rates?.rates?.[currency] || 1;
      const PRESETS = {
        "ุนููุงู - ุนุจุฏูู":       { pps: 1100, rentPps: 8.5, loc: "A" },
        "ุนููุงู - ุฎูุฏุง":        { pps: 950,  rentPps: 7.5, loc: "A" },
        "ุนููุงู - ุชูุงุน ุงูุนูู":  { pps: 850,  rentPps: 6.8, loc: "B" },
        "ุงูุฒุฑูุงุก - ุงูุฌุฏูุฏุฉ":   { pps: 450,  rentPps: 4.0, loc: "B" },
        "ุงูุนูุจุฉ - ุงูุดุงุทุฆ":     { pps: 1000, rentPps: 7.2, loc: "A" },
      };
      function readQP(key, def) { const v = new URLSearchParams(window.location.search).get(key); return v!==null ? v : def; }
      function setQP(obj){ const p = new URLSearchParams(window.location.search); Object.entries(obj).forEach(([k,v])=>{ if(v===null||v===undefined||v===""){p.delete(k);} else {p.set(k,v);} }); history.replaceState(null,"","?"+p.toString()); }

      const [preset, setPreset] = useState(readQP("preset","ุนููุงู - ุนุจุฏูู"));
      const d = PRESETS[preset] || PRESETS["ุนููุงู - ุนุจุฏูู"];
      const [area, setArea] = useState(Number(readQP("area", 150)));
      const [ppsJOD, setPps] = useState(Number(readQP("pps", d.pps)));
      const [rentPpsJOD, setRentPps] = useState(Number(readQP("rpps", d.rentPps)));
      const [loc, setLoc] = useState(readQP("loc", d.loc));
      const [age, setAge] = useState(Number(readQP("age", 5)));
      const [beds, setBeds] = useState(Number(readQP("beds", 3)));
      const [baths, setBaths] = useState(Number(readQP("baths", 2)));
      const [floor, setFloor] = useState(Number(readQP("floor", 3)));
      const [view, setView] = useState(readQP("view","City"));
      const [corner, setCorner] = useState(readQP("corner","no"));
      const [parking, setParking] = useState(readQP("parking","yes"));

      const locMult = { A:1.15, B:1.0, C:0.88 }[loc] || 1.0;
      const ageMult = Math.max(0.8, 1 - (Math.max(0, age-3) * 0.01));
      const bedAdj = 1 + Math.min(Math.max((beds - 2) * 0.035, -0.07), 0.21);
      const bathAdj = 1 + Math.min(Math.max((baths - 1) * 0.03, -0.05), 0.18);
      const floorAdj = 1 + Math.min(floor, 10) * 0.01;
      const viewAdj = { City:1.00, Garden:1.03, Sea:1.08 }[view] || 1.0;
      const cornerAdj = corner === "yes" ? 1.02 : 1.0;
      const parkingAdjJOD = parking === "yes" ? 3000 : 0;

      const fairJOD = (area||0) * (ppsJOD||0) * locMult * ageMult * bedAdj * bathAdj * floorAdj * viewAdj * cornerAdj + parkingAdjJOD;
      const lowJOD = fairJOD * 0.95, highJOD = fairJOD * 1.05;
      const fairSel = fairJOD * r, lowSel = lowJOD * r, highSel = highJOD * r;

      const monthlyRentJOD = (rentPpsJOD||0) * (area||0);
      const opx = 0.08; // ูุตุงุฑูู ุชุดุบูููุฉ ุชูุฏูุฑูุฉ
      const annualNetSel = monthlyRentJOD * 12 * (1 - opx) * r;
      const capRate = fairSel ? (annualNetSel / fairSel) * 100 : 0;

      useEffect(()=>{ setQP({preset,area,pps:ppsJOD,rpps:rentPpsJOD,loc,age,beds,baths,floor,view,corner,parking}); },
        [preset,area,ppsJOD,rentPpsJOD,loc,age,beds,baths,floor,view,corner,parking]);

      const waMsg =
`ุชูููู LIVORA (ุจุฏูู ุฑุจุง):
Preset: ${preset}
ูุณุงุญุฉ: ${area} ูยฒ | ุณุนุฑ/ูยฒ (JOD): ${ppsJOD} | ุฅูุฌุงุฑ/ูยฒ (JOD): ${rentPpsJOD}
ูููุน: ${loc} | ุนูุฑ: ${age} | ุบุฑู/ุญููุงูุงุช: ${beds}/${baths} | ุทุงุจู: ${floor} | ุฅุทูุงูุฉ: ${view} | ุฒุงููุฉ: ${corner} | ูููู: ${parking}

ุงูุณุนุฑ ุงูุนุงุฏู (${currency}): ${moneyByCode(fairSel, currency)}
ุงููุฏู (${currency}): ${moneyByCode(lowSel, currency)} - ${moneyByCode(highSel, currency)}
ุงูุฏุฎู ุงูุตุงูู ุงูุณููู (${currency}): ${moneyByCode(annualNetSel, currency)} | Cap Rate: ${capRate.toFixed(1)}%
`;
      const wa = BRAND.whatsappBase + "?text=" + encodeURIComponent(waMsg);
      const mail = "mailto:"+BRAND.email+"?subject="+encodeURIComponent("ุชูููู LIVORA")+"&&body="+encodeURIComponent(waMsg);

      return (
        <div className="rounded-3xl border bg-white p-5 shadow-sm">
          <div className="font-bold mb-2">Valuator Pro โ ุชุณุนูุฑ + ุนุงุฆุฏ (ุจุฏูู ุฑุจุง)</div>

          <div className="grid md:grid-cols-3 gap-2 text-sm mb-2">
            <select className="px-3 py-2 rounded-xl border" value={preset} onChange={e=>{
              const p=e.target.value; setPreset(p);
              const d=PRESETS[p]; if(d){ setPps(d.pps); setRentPps(d.rentPps); setLoc(d.loc); }
            }}>
              {Object.keys(PRESETS).map(k => <option key={k} value={k}>{k}</option>)}
            </select>
            <input className="px-3 py-2 rounded-xl border" type="number" min="20" value={area} onChange={e=>setArea(Number(e.target.value))} placeholder="ุงููุณุงุญุฉ (ูยฒ)"/>
            <input className="px-3 py-2 rounded-xl border" type="number" min="100" value={ppsJOD} onChange={e=>setPps(Number(e.target.value))} placeholder="ุณุนุฑ/ูยฒ (JOD)"/>
          </div>

          <div className="grid md:grid-cols-4 gap-2 text-sm mb-2">
            <input className="px-3 py-2 rounded-xl border" type="number" min="0" value={age} onChange={e=>setAge(Number(e.target.value))} placeholder="ุนูุฑ ุงูุจูุงุก"/>
            <input className="px-3 py-2 rounded-xl border" type="number" min="0" value={beds} onChange={e=>setBeds(Number(e.target.value))} placeholder="ุบุฑู"/>
            <input className="px-3 py-2 rounded-xl border" type="number" min="0" value={baths} onChange={e=>setBaths(Number(e.target.value))} placeholder="ุญููุงูุงุช"/>
            <input className="px-3 py-2 rounded-xl border" type="number" min="0" value={floor} onChange={e=>setFloor(Number(e.target.value))} placeholder="ุงูุทุงุจู"/>
          </div>
          <div className="grid md:grid-cols-4 gap-2 text-sm mb-3">
            <select className="px-3 py-2 rounded-xl border" value={loc} onChange={e=>setLoc(e.target.value)}>
              <option value="A">ูููุน A (ููุชุงุฒ)</option>
              <option value="B">ูููุน B (ุฌูุฏ)</option>
              <option value="C">ูููุน C (ูุชูุณุท)</option>
            </select>
            <select className="px-3 py-2 rounded-xl border" value={view} onChange={e=>setView(e.target.value)}>
              <option value="City">City</option><option value="Garden">Garden</option><option value="Sea">Sea</option>
            </select>
            <select className="px-3 py-2 rounded-xl border" value={corner} onChange={e=>setCorner(e.target.value)}>
              <option value="no">ููุณุช ุฒุงููุฉ</option><option value="yes">ุฒุงููุฉ</option>
            </select>
            <select className="px-3 py-2 rounded-xl border" value={parking} onChange={e=>setParking(e.target.value)}>
              <option value="yes">ูููู</option><option value="no">ุจุฏูู ูููู</option>
            </select>
          </div>

          <div className="mt-3 grid md:grid-cols-3 gap-3 text-sm">
            <div className="rounded-2xl bg-neutral-50 border p-4">
              <div className="text-neutral-600">ุงูุณุนุฑ ุงูุนุงุฏู</div>
              <div className="text-lg font-extrabold">{moneyByCode(fairSel, currency)}</div>
              <div className="text-xs text-neutral-500">ูุฏู: {moneyByCode(lowSel, currency)} โ {moneyByCode(highSel, currency)}</div>
            </div>
            <div className="rounded-2xl bg-neutral-50 border p-4">
              <div className="text-neutral-600">Cap Rate</div>
              <div className="text-lg font-extrabold">{capRate.toFixed(1)}%</div>
            </div>
            <div className="rounded-2xl bg-neutral-50 border p-4">
              <div className="text-neutral-600">ุตุงูู ุงูุฏุฎู ุงูุณููู</div>
              <div className="text-lg font-extrabold">{moneyByCode(annualNetSel, currency)}</div>
            </div>
          </div>

          <div className="mt-4 flex flex-col sm:flex-row gap-2">
            <a href={wa} target="_blank" className="px-4 py-2 rounded-xl bg-black text-white text-sm text-center"
               onClick={()=>track('valuator_share_whatsapp', {preset, area, ppsJOD, rentPpsJOD})}>
              ุฃุฑุณู ุงูุชูููู ุนูู ูุงุชุณุงุจ
            </a>
            <a href={mail} className="px-4 py-2 rounded-xl border text-sm text-center"
               onClick={()=>track('valuator_share_email', {preset, area, ppsJOD})}>
              ุฃุฑุณู ุงูุชูููู ุนูู ุงูุจุฑูุฏ
            </a>
            <button onClick={()=>{
                navigator.clipboard.writeText(window.location.href);
                track('valuator_copy_link', {preset, area, ppsJOD});
              }}
              className="px-4 py-2 rounded-xl border text-sm text-center">ูุณุฎ ุฑุงุจุท ูุฐุง ุงูุชูููู</button>
          </div>

          <div className="mt-3 text-xs text-neutral-500 leading-6">
            * ุชูุฏูุฑ ุชูุฑูุจู ุงุณุชุฑุดุงุฏู. ููุชูููู ุงูุฑุณูู ูุญุชุงุฌ ูุซุงุฆู ููููุน ุฏููู ูุตูุฑ/ูุนุงููุฉ.
          </div>
        </div>
      );
    }

    // ูุณู ุงูุนูุงุฑุงุช โ ููุฑุฃ ูู CSV + ููุงุชุฑ + ููุถููุงุช + ููููุฒ
    function ListingsSection({currency, rates}){
      const [listings, setListings] = useState([]);
      const [loadingCSV, setLoadingCSV] = useState(true);

      // ููุงุชุฑ
      const [q, setQ] = useState("");
      const [city, setCity] = useState("ุงููู");
      const [type, setType] = useState("ุงููู");
      const [maxPrice, setMaxPrice] = useState("");

      // ููุถููุงุช
      const [fav, setFav] = useState(()=>{
        try { return JSON.parse(localStorage.getItem("fav")||"[]"); } catch { return []; }
      });
      function toggleFav(title){
        setFav(prev=>{
          const has = prev.includes(title);
          const next = has ? prev.filter(t=>t!==title) : [...prev, title];
          localStorage.setItem("fav", JSON.stringify(next));
          return next;
        });
      }

      function parseCSV(text){
        const lines = text.trim().split(/\r?\n/);
        const header = lines[0].split(",").map(h => h.trim());
        const rows = lines.slice(1).map(line => {
          // ูุฏุนู ููู ูููุง ููุงุตู ุฏุงุฎู ุนูุงูุงุช ุชูุตูุต
          const cells = [];
          let cur = "", inQ = false;
          for (let i=0;i<line.length;i++){
            const c = line[i];
            if(c==='\"'){ inQ = !inQ; continue; }
            if(c===',' && !inQ){ cells.push(cur); cur=""; }
            else { cur+=c; }
          }
          cells.push(cur);
          const obj = {};
          header.forEach((h,idx)=> obj[h] = (cells[idx]||"").trim());
          return obj;
        });
        return rows;
      }

      useEffect(()=>{
        if(!CSV_URL){ setLoadingCSV(false); return; }
        fetch(CSV_URL)
          .then(r=>r.text())
          .then(t=>{
            const rows = parseCSV(t);
            const today = new Date();

            const mapped = rows
              .filter(r => (r.approved?.toLowerCase?.() === "true") || r.approved === "TRUE" || r.approved === "1" || r.approved === "ุตุญ")
              .map(r=>{
                const priceJOD = Number((r.priceJOD||"").toString().replace(/[^\d.]/g,"")) || 0;
                const is_featured = String(r.is_featured||"").toLowerCase() === "true";
                const until = r.featured_until ? new Date(r.featured_until) : null;
                const featuredActive = is_featured && until && (until >= today);
                return {
                  tag: r.tag || r.type || "ุนูุงุฑ",
                  title: r.title || "โ",
                  city: r.city || "",
                  meta: r.meta || "",
                  img: r.img || "https://images.unsplash.com/photo-1501183638710-841dd1904471?q=80&w=1200&auto=format&fit=crop",
                  offMarket: String(r.offMarket||"").toLowerCase() === "true",
                  priceJOD,
                  is_featured: featuredActive,
                  featured_until: r.featured_until || ""
                };
              })
              .sort((a,b)=> (b.is_featured?1:0) - (a.is_featured?1:0)); // ุงูููููุฒ ุฃููุงู

            setListings(mapped);
            setLoadingCSV(false);
          })
          .catch(e=>{
            console.error("CSV error", e);
            setLoadingCSV(false);
          });
      },[]);

      // ุงุดุชูุงู ุงููุฏู ูุงูุฃููุงุน
      const cities = useMemo(()=>{
        const s = new Set(["ุงููู"]);
        listings.forEach(l=> l.city && s.add(l.city));
        return Array.from(s);
      }, [listings]);
      const types = useMemo(()=>{
        const s = new Set(["ุงููู"]);
        listings.forEach(l=> l.tag && s.add(l.tag));
        return Array.from(s);
      }, [listings]);

      // ุชุทุจูู ุงูููุชุฑุฉ
      const filtered = listings.filter(l=>{
        const okQ = !q || (l.title+" "+l.meta+" "+l.city).toLowerCase().includes(q.toLowerCase());
        const okCity = (city==="ุงููู") || (l.city===city);
        const okType = (type==="ุงููู") || (l.tag===type);
        const okPrice = !maxPrice || (l.priceJOD <= Number(maxPrice));
        return okQ && okCity && okType && okPrice;
      });

      // ุชุนุฑูุถ ุงููุชุงุฆุฌ ูููููููุงุช ุงูุฃุฎุฑู (ุฎุฑูุทุฉ ูู ูุนูููุงูุง ูุงุญููุง)
      window.__LIVORA_LATEST_LISTINGS__ = filtered;

      return (
        <section id="listings" className="max-w-7xl mx-auto px-4 mb-14">
          <div className="flex items-end justify-between mb-3">
            <h2 className="text-2xl md:text-3xl font-extrabold">ุนูุงุฑุงุช ูููุฒุฉ</h2>
            <div className="flex gap-3">
              {FORM_URL
                ? <a href={FORM_URL} target="_blank" className="text-sm underline underline-offset-4" onClick={()=>track('click_submit_form')}>ูููุฐุฌ ุฑูุน ุนูุงุฑ</a>
                : <span className="text-xs px-3 py-1 rounded-full border bg-neutral-100 text-neutral-500">ุฃุถู ุฑุงุจุท ุงููููุฐุฌ ูุงุญููุง</span>}
            </div>
          </div>

          {/* ุดุฑูุท ุงูููุงุชุฑ */}
          <div className="grid md:grid-cols-4 gap-2 mb-4">
            <input className="px-3 py-2 rounded-xl border text-sm" placeholder="ุจุญุซ ุจุงูุนููุงู/ุงููุตู/ุงููุฏููุฉ" value={q} onChange={e=>setQ(e.target.value)} />
            <select className="px-3 py-2 rounded-xl border text-sm" value={city} onChange={e=>setCity(e.target.value)}>{cities.map(c => <option key={c}>{c}</option>)}</select>
            <select className="px-3 py-2 rounded-xl border text-sm" value={type} onChange={e=>setType(e.target.value)}>{types.map(t => <option key={t}>{t}</option>)}</select>
            <input className="px-3 py-2 rounded-xl border text-sm" type="number" min="0" placeholder="ุณูู ุงูุณุนุฑ (JOD)" value={maxPrice} onChange={e=>setMaxPrice(e.target.value)} />
          </div>

          <div className="text-xs text-neutral-600 mb-2">{loadingCSV ? "ุฌุงุฑู ุชุญููู ุงูุนูุงุฑุงุชโฆ" : `ุนุฏุฏ ุงููุชุงุฆุฌ: ${filtered.length}`}</div>

          <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-5">
            {filtered.map((l,i)=>(
              <article key={i} className={"rounded-3xl overflow-hidden border bg-white shadow-sm " + (l.is_featured ? "ring-2 ring-yellow-400" : "")}>
                <div className="relative">
                  <img src={l.img} alt={l.title} className="h-48 w-full object-cover" />
                  {l.is_featured
                    ? <div className="absolute top-3 right-3 px-3 py-1 rounded-full text-xs bg-yellow-300 border font-bold">ููููุฒ</div>
                    : <div className="absolute top-3 right-3 px-3 py-1 rounded-full text-xs bg-white/90 border">{l.tag||"ุนูุงุฑ"}</div>}
                </div>
                <div className="p-4">
                  <div className="flex items-start justify-between gap-2">
                    <div className="text-lg font-bold">{l.title}</div>
                    <button onClick={()=>toggleFav(l.title)} className={"text-sm px-2 py-1 rounded-full border " + (fav.includes(l.title) ? "bg-yellow-200" : "bg-white")}>
                      {fav.includes(l.title) ? "โ" : "โ"}
                    </button>
                  </div>
                  <div className="text-sm text-neutral-600 mt-1">{l.city ? `๐ ${l.city} โ ` : ""}{l.meta}</div>
                  <div className="mt-3 font-extrabold">{Number(l.priceJOD||0).toLocaleString()} ุฏููุงุฑ</div>
                  {l.offMarket && <div className="mt-2 text-xs bg-neutral-50 border rounded-xl p-2">Off-Market (ุชูุงุตูู ุฅุถุงููุฉ ุจุนุฏ NDA)</div>}
                  <div className="mt-4 flex gap-2">
                    <a href={whatsappLink} target="_blank" className="flex-1 text-center px-4 py-2 rounded-xl bg-black text-white text-sm"
                       onClick={()=>track('click_whatsapp', {position: 'listing_card', title:l.title})}>ุงุณุชูุณุงุฑ ูุงุชุณุงุจ</a>
                    <a href={"mailto:"+BRAND.email+"?subject="+encodeURIComponent("ุงุณุชูุณุงุฑ ุนู: "+(l.title||"ุนูุงุฑ"))}
                       className="flex-1 text-center px-4 py-2 rounded-xl border text-sm"
                       onClick={()=>track('click_email', {position:'listing_card', title:l.title})}>ูุฑุงุณูุฉ ุจุฑูุฏูุฉ</a>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </section>
      );
    }

    // ุทูุจ ุนูุงุฑ ุณุฑูุน (ูุงุชุณุงุจ)
    function RequestWizard(){
      const [step,setStep]=useState(1);
      const [type,setType]=useState("ุฃุฑุถ");
      const [area,setArea]=useState("ุนููุงู");
      const [budget,setBudget]=useState("");
      const [name,setName]=useState("");
      const [phone,setPhone]=useState("");
      const msg =
        "ุทูุจ ุนูุงุฑ:\n" +
        "ุงูููุน: " + type + "\n" +
        "ุงูููุทูุฉ: " + area + "\n" +
        "ุงูููุฒุงููุฉ: " + (budget || "ุบูุฑ ูุญุฏุฏุฉ") + "\n" +
        "ุงูุงุณู: " + (name || "โ") + "\n" +
        "ุงููุงุชู: " + (phone || "โ");
      const wa = BRAND.whatsappBase + "?text=" + buildWhatsAppMessage(msg);
      return (
        <div className="rounded-3xl border bg-white p-5 shadow-sm">
          <div className="font-bold mb-2">ุทูุจ ุนูุงุฑ ุฎูุงู 30 ุซุงููุฉ</div>
          {step===1 && (
            <div className="grid md:grid-cols-3 gap-2 text-sm">
              <select className="px-3 py-2 rounded-xl border" value={type} onChange={e=>setType(e.target.value)}>
                <option>ุฃุฑุถ</option><option>ุดูุฉ</option><option>ูุฌูุน ุชุฌุงุฑู</option><option>ูุฏุฑุณุฉ</option><option>ููุฏู/ููุชุฌุน</option>
              </select>
              <input className="px-3 py-2 rounded-xl border" placeholder="ุงูููุทูุฉ/ุงููุฏููุฉ" value={area} onChange={e=>setArea(e.target.value)} />
              <input className="px-3 py-2 rounded-xl border" placeholder="ุงูููุฒุงููุฉ (JOD)" value={budget} onChange={e=>setBudget(e.target.value)} />
            </div>
          )}
          {step===2 && (
            <div className="grid md:grid-cols-2 gap-2 text-sm">
              <input className="px-3 py-2 rounded-xl border" placeholder="ุงุณูู" value={name} onChange={e=>setName(e.target.value)} />
              <input className="px-3 py-2 rounded-xl border" placeholder="ุฑูู ุงููุงุชู" value={phone} onChange={e=>setPhone(e.target.value)} />
            </div>
          )}
          {step===3 && (
            <div className="text-sm bg-neutral-50 border rounded-2xl p-3 leading-7 whitespace-pre-wrap">{msg}</div>
          )}
          <div className="mt-3 flex gap-2">
            {step>1 && <button className="px-4 py-2 rounded-xl border text-sm" onClick={()=>setStep(s=>Math.max(1,s-1))}>ุฑุฌูุน</button>}
            {step<3 && <button className="px-4 py-2 rounded-xl bg-black text-white text-sm" onClick={()=>setStep(s=>Math.min(3,s+1))}>ุงูุชุงูู</button>}
            {step===3 && <a href={wa} target="_blank" className="px-4 py-2 rounded-xl bg-black text-white text-sm"
                            onClick={()=>track('click_whatsapp', {position:'request_wizard'})}>ุฅุฑุณุงู ุนุจุฑ ูุงุชุณุงุจ</a>}
          </div>
        </div>
      );
    }

    function App(){
      const [currency,setCurrency] = useState("JOD");
      const rates = useRates();
      useEffect(()=>{ document.title = BRAND.nameEn + " โ " + BRAND.nameAr; },[]);
      return (
        <div dir="rtl" className="min-h-screen bg-neutral-50 text-neutral-900">
          <header className="w-full border-b bg-white/80 backdrop-blur sticky top-0 z-50">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-2xl bg-black text-white grid place-items-center font-bold">L</div>
                <div className="font-extrabold text-xl tracking-tight">{BRAND.nameEn} | {BRAND.nameAr}</div>
              </div>
              <div className="flex items-center gap-3">
                <select
                  className="px-3 py-2 rounded-xl border text-sm"
                  value={currency}
                  onChange={e=>{ setCurrency(e.target.value); track('change_currency', {to: e.target.value}); }}>
                  {CURRENCIES.map(c=> <option key={c.code} value={c.code}>{c.label}</option>)}
                </select>
                <a href="#listings" className="hidden md:inline hover:opacity-70 text-sm">ุนูุงุฑุงุช ูููุฒุฉ</a>
                <a href="#tools" className="hidden md:inline hover:opacity-70 text-sm">ุฃุฏูุงุช</a>
                <a href="#contact" className="hidden md:inline hover:opacity-70 text-sm">ุชูุงุตู</a>
                <a href={whatsappLink} target="_blank"
                   className="px-4 py-2 rounded-2xl bg-black text-white shadow hover:shadow-lg text-sm"
                   onClick={()=>track('click_whatsapp', {position: 'header'})}>
                  ูุงุชุณุงุจ ููุฑู
                </a>
              </div>
            </div>
          </header>

          <section className="relative overflow-hidden">
            <div className="absolute inset-0 -z-10 bg-gradient-to-b from-neutral-100 to-neutral-50"></div>
            <div className="max-w-7xl mx-auto px-4 pt-14 pb-10 grid lg:grid-cols-2 gap-10 items-center">
              <div>
                <h1 className="text-3xl md:text-5xl font-extrabold leading-tight">
                  ููุตุฉ {BRAND.nameAr} ุงูุนูุงุฑูุฉ โ ุตููุงุช ุฃุฑุงุถูุ ุดููุ ูุฌูุนุงุช ููุฏุงุฑุณ
                </h1>
                <p className="mt-4 text-neutral-600 text-lg">
                  ููุญููู ุงูุฌุฏูุฉ ุฅูู ุตููุงุช: ุชุญูู ููููุฉุ ุชูุซูู ุฑุณููุ ุชุณููู ุงุญุชุฑุงููุ ุดุจูุฉ ูุณุชุซูุฑูู ูุญููุฉ ูุฎููุฌูุฉ โ ูุน ุฃุฏูุงุช ููุฑูุฉ ุชุฒูุฏ ุงุญุชูุงููุฉ ุงูุฅุบูุงู.
                </p>
                <div className="mt-6 flex flex-col sm:flex-row gap-3">
                  <a href="#listings" className="px-5 py-3 rounded-2xl bg-black text-white font-semibold shadow hover:shadow-lg">ุงุณุชุนุฑุถ ุงูุนูุงุฑุงุช</a>
                  {FORM_URL
                   ? <a href={FORM_URL} target="_blank" className="px-5 py-3 rounded-2xl bg-white border font-semibold hover:bg-neutral-100">ุฃุถู ุนูุงุฑู ุงูุขู</a>
                   : <a href="#contact" className="px-5 py-3 rounded-2xl bg-white border font-semibold hover:bg-neutral-100">ุฃุถู ุนูุงุฑู / ุงุทูุจ ุนูุงุฑ</a>}
                </div>
                <div className="mt-4 grid grid-cols-3 gap-3 text-center">
                  <div className="rounded-2xl bg-white border p-4"><div className="text-2xl font-extrabold">0</div><div className="text-xs text-neutral-600">ูุณุชุซูุฑ ูุดุท</div></div>
                  <div className="rounded-2xl bg-white border p-4"><div className="text-2xl font-extrabold">0</div><div className="text-xs text-neutral-600">ุนูุงุฑ ููุซูู</div></div>
                  <div className="rounded-2xl bg-white border p-4"><div className="text-2xl font-extrabold">0</div><div className="text-xs text-neutral-600">ุตููุฉ ููุบููุฉ</div></div>
                </div>
              </div>
              <div className="relative">
                <img src="https://images.unsplash.com/photo-1501183638710-841dd1904471?q=80&w=1600&auto=format&fit=crop" alt="Real estate hero" className="rounded-3xl shadow-xl w-full h-[360px] object-cover"/>
                <div className="absolute -bottom-5 left-5 right-5 md:left-auto md:right-5 bg-white rounded-2xl shadow p-4 flex items-center gap-4">
                  <div className="hidden md:block h-12 w-12 rounded-xl bg-neutral-900 text-white grid place-items-center font-bold">โ</div>
                  <div>
                    <div className="font-bold">ุณูุงุณุฉ ุงูุชุญูู ูุจู ุงููุดุฑ</div>
                    <div className="text-sm text-neutral-600">ูุง ูููุดุฑ ุฃู ุนูุงุฑ ุฏูู ูุซุงุฆู ูุตูุฑ/ููุฏูู ูุงูุนูุฉ ููููุน ุฏููู.</div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section id="tools" className="max-w-7xl mx-auto px-4 mb-12">
            <div className="grid lg:grid-cols-4 gap-4">
              <RequestWizard />
              <CommissionCalculator currency={currency} rates={rates} />
              <RoiCalculator currency={currency} rates={rates} />
              <ValuatorPro currency={currency} rates={rates} />
            </div>
          </section>

          <ListingsSection currency={currency} rates={rates} />

          <!-- (ุงุฎุชูุงุฑู ูุงุญููุง) ุฎุฑูุทุฉ ุชูุงุนููุฉ:
          <section className="max-w-7xl mx-auto px-4 mb-10">
            <h3 className="text-xl font-extrabold mb-3">ุงูุฎุฑูุทุฉ</h3>
            <div id="mapBox" className="w-full h-80 rounded-2xl border"></div>
          </section>
          -->

          <section id="contact" className="max-w-7xl mx-auto px-4 mb-20">
            <div className="grid lg:grid-cols-2 gap-6">
              <div className="rounded-3xl border bg-white p-6 md:p-10 shadow-sm">
                <h3 className="text-2xl font-extrabold">ุชูุงุตู ุณุฑูุน</h3>
                <p className="text-neutral-600 mt-2">ุงุฎุชุฑ ุงูุทุฑููุฉ ุงูุฃุณูู ูู: ูุงุชุณุงุจ ุฃู ุจุฑูุฏ ุฅููุชุฑููู.</p>
                <div className="mt-6 grid gap-3">
                  <a href={whatsappLink} target="_blank" className="px-5 py-3 rounded-2xl bg-black text-white font-semibold text-center"
                     onClick={()=>track('click_whatsapp', {position: 'contact_section'})}>
                    ูุงุชุณุงุจ ููุฑู: {BRAND.phoneIntl}
                  </a>
                  <a href={"mailto:"+BRAND.email} className="px-5 py-3 rounded-2xl border font-semibold text-center"
                     onClick={()=>track('click_email', {position: 'contact_section'})}>
                    ูุฑุงุณูุฉ ุจุฑูุฏูุฉ: {BRAND.email}
                  </a>
                </div>
                <div className="text-xs text-neutral-500 mt-2">ุจุงูุถุบุท ุนูู ุงูุฑูุงุจุทุ ุชูุงูู ุนูู ุงูุดุฑูุท ูุณูุงุณุฉ ุงูุฎุตูุตูุฉ.</div>
              </div>
              <div className="rounded-3xl border bg-white p-6 md:p-10 shadow-sm">
                <h3 className="text-2xl font-extrabold">ุณูุงุณุฉ ุงููุฒุงูุฉ ูุงูููุซูููุฉ</h3>
                <ul className="list-disc pr-6 mt-3 text-neutral-700 leading-8 text-sm">
                  <li>ูุง ููุดุฑ ุฃู ุนูุงุฑ ุจุฏูู ูุซุงุฆู ุฃุณุงุณูุฉ ูุตูุฑ/ููุฏูู ุญุฏูุซ.</li>
                  <li>ุงูุงุชูุงู ุนูู ุงูุนูููุฉ ูุชุงุจููุง ูุจู ุงูุชุณูููุ ูุดูุงููุฉ ูุงููุฉ ูู ูู ุฎุทูุฉ.</li>
                  <li>ุญูุธ ุณุฑูุฉ ุจูุงูุงุช ุงููุงูู ูุงููุดุชุฑู ูุนุฏู ูุดุงุฑูุฉ ุงูุชูุงุตูู ุฏูู ุฅุฐู.</li>
                  <li>ุญูุงูุฉ ุญููู ุฌููุน ุงูุฃุทุฑุงู ููู ุงูููุงููู ุงูุฃุฑุฏููุฉ.</li>
                </ul>
                <div className="mt-6 rounded-2xl bg-neutral-50 border p-4 text-sm text-neutral-600">
                  ููุชุนุงูู ุงูููุฑู ุจุงููุดุงุฑูุน ุงููุจูุฑุฉ:
                  <div className="mt-2 font-bold">ุงุชุตู: {BRAND.phoneIntl} โข ุงูุจุฑูุฏ: {BRAND.email}</div>
                </div>
              </div>
            </div>
          </section>

          <footer className="border-t bg-white">
            <div className="max-w-7xl mx-auto px-4 py-8 text-sm flex flex-col md:flex-row items-center md:items-start justify-between gap-4">
              <div className="text-neutral-600">ยฉ {new Date().getFullYear()} {BRAND.nameEn} โ ุฌููุน ุงูุญููู ูุญููุธุฉ.</div>
              <div className="flex gap-4 text-neutral-600">
                <a href="#" className="hover:opacity-70">ุงูุดุฑูุท ูุงูุฃุญูุงู</a>
                <a href="#" className="hover:opacity-70">ุณูุงุณุฉ ุงูุฎุตูุตูุฉ</a>
                <a href={whatsappLink} target="_blank" className="hover:opacity-70">ูุงุชุณุงุจ</a>
              </div>
            </div>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
